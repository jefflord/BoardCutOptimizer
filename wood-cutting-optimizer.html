<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wood Cutting Optimizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .section {
            border-bottom: 1px solid #eee;
        }

        .section-header {
            background: #f8f9fa;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 13px;
            color: #495057;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-header::after {
            content: '‚ñº';
            font-size: 10px;
            transition: transform 0.2s;
        }

        .section.collapsed .section-header::after {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 12px;
            display: block;
        }

        .section.collapsed .section-content {
            display: none;
        }

        .panel-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .panel-item {
            display: grid;
            grid-template-columns: 60px 50px 80px 40px 30px 30px;
            gap: 8px;
            padding: 4px 0;
            align-items: center;
            font-size: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .panel-item:last-child {
            border-bottom: none;
        }

        .panel-item input {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid #ddd;
            border-radius: 2px;
            font-size: 11px;
        }

        .panel-item .qty {
            text-align: center;
        }

        .panel-item .actions {
            display: flex;
            gap: 2px;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 11px;
            cursor: pointer;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn.btn-sm {
            padding: 2px 4px;
            font-size: 10px;
        }

        .btn.btn-danger {
            background: #dc3545;
        }

        .btn.btn-danger:hover {
            background: #c82333;
        }

        .btn.btn-success {
            background: #28a745;
        }

        .add-panel {
            margin-top: 8px;
        }

        .stock-sheet-input {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .stock-sheet-input input {
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 2px;
            font-size: 12px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
        }

        .option input[type="number"] {
            width: 60px;
            padding: 2px 4px;
            border: 1px solid #ddd;
            border-radius: 2px;
        }

        .toggle {
            width: 40px;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
        }

        .toggle.active {
            background: #007bff;
        }

        .toggle::after {
            content: '';
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.2s;
        }

        .toggle.active::after {
            left: 22px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: auto;
            background: white;
            padding: 20px;
        }

        .cutting-board {
            border: 2px solid #333;
            background: #f8f9fa;
            position: relative;
            margin: 20px;
            min-width: 200px;
            min-height: 150px;
            max-width: 700px;
            max-height: 500px;
        }

        .cut-piece {
            position: absolute;
            border: 1px solid #666;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 11px;
            font-weight: 500;
            cursor: move;
            user-select: none;
        }

        .cut-piece:nth-child(odd) {
            background: rgba(220, 230, 255, 0.7);
        }

        .cut-piece:nth-child(even) {
            background: rgba(255, 220, 220, 0.7);
        }

        .cut-piece.dragging {
            opacity: 0.5;
            z-index: 1000;
        }

        .cut-piece .dimensions {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .cut-piece .label {
            font-size: 10px;
            color: #666;
        }

        .stats-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            min-width: 200px;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-panel h4 {
            margin-bottom: 8px;
            color: #495057;
            font-size: 13px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .optimize-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .optimize-btn:hover {
            background: #218838;
        }

        .waste-area {
            background: rgba(255, 0, 0, 0.1) !important;
            border: 1px dashed #ff0000 !important;
        }

        .dragging-over {
            background: rgba(0, 123, 255, 0.1) !important;
        }

        .panel-headers {
            display: grid;
            grid-template-columns: 60px 50px 80px 40px 30px 30px;
            gap: 8px;
            font-weight: 600;
            font-size: 11px;
            color: #666;
            padding: 4px 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="section">
            <div class="section-header">üìã Panels</div>
            <div class="section-content">
                <div class="panel-headers">
                    <div>Length</div>
                    <div>Width</div>
                    <div>Fraction</div>
                    <div>Qty</div>
                    <div></div>
                    <div></div>
                </div>
                <div class="panel-list" id="panelList">
                    <!-- Panels will be added here -->
                </div>
                <div class="add-panel">
                    <div style="display: grid; grid-template-columns: 60px 50px 80px 1fr; gap: 8px; margin-bottom: 8px;">
                        <input type="number" id="newLength" placeholder="24" step="0.01">
                        <input type="number" id="newWidth" placeholder="9.74" step="0.01">
                        <div></div>
                        <button class="btn" onclick="addPanel()">Add Panel</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 60px 50px 80px 1fr; gap: 8px;">
                        <div></div>
                        <div></div>
                        <input type="number" id="newQty" placeholder="1" min="1">
                        <div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">üì¶ Stock Sheets</div>
            <div class="section-content">
                <div class="stock-sheet-input">
                    <input type="number" id="stockLength" placeholder="Length" value="96" step="0.01">
                    <input type="number" id="stockWidth" placeholder="Width" value="48" step="0.01">
                    <input type="number" id="stockQty" placeholder="Qty" value="1" min="1">
                </div>
                <button class="btn" onclick="addStockSheet()">Update Stock Sheet</button>
                <div style="margin-top: 8px; font-size: 11px; color: #666;">
                    Current: <span id="currentStockDisplay">96 √ó 48</span>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">‚öôÔ∏è Options</div>
            <div class="section-content">
                <div class="options">
                    <div class="option">
                        <span>Cut/blade/kerf thickness</span>
                        <input type="number" id="kerfThickness" value="0.25" step="0.01">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="canvas-container">
            <div class="cutting-board" id="cuttingBoard">
                <!-- Cut pieces will be placed here -->
            </div>
            
            <div class="stats-panel">
                <h4>Global Statistics</h4>
                <div class="stat-row"><span>Used stock sheets</span><span id="usedSheets">0</span></div>
                <div class="stat-row"><span>Total used area</span><span id="totalUsed">0</span></div>
                <div class="stat-row"><span>Total wasted area</span><span id="totalWasted">0</span></div>
                <div class="stat-row"><span>Total cuts</span><span id="totalCuts">0</span></div>
                <div class="stat-row"><span>Optimization priority</span><span>Least wasted area</span></div>
            </div>
            
            <button class="optimize-btn" onclick="optimizeCutting()">Optimize Layout</button>
        </div>
    </div>

    <script>
        // Global state
        let panels = [];
        let stockSheets = [{ length: 96, width: 48, qty: 1 }];
        let placedPieces = [];
        let draggedElement = null;
        let dragOffset = { x: 0, y: 0 };

        // Initialize with default panels
        const defaultPanels = [
            { length: 24, width: 14.62, qty: 2 },
            { length: 20.98, width: 9.74, qty: 1 },
            { length: 24, width: 9.74, qty: 1 },
            { length: 13.36, width: 9.74, qty: 1 },
            { length: 13.99, width: 9.74, qty: 1 },
            { length: 10.97, width: 9.74, qty: 1 },
            { length: 14.18, width: 9.74, qty: 1 }
        ];

        // Initialize
        defaultPanels.forEach(panel => panels.push(panel));
        renderPanels();
        updateCuttingBoard();
        updateStockDisplay();
        optimizeCutting();

        function addPanel() {
            const length = parseFloat(document.getElementById('newLength').value);
            const width = parseFloat(document.getElementById('newWidth').value);
            const qty = parseInt(document.getElementById('newQty').value) || 1;

            if (length && width) {
                panels.push({ length, width, qty });
                renderPanels();
                
                // Clear inputs
                document.getElementById('newLength').value = '';
                document.getElementById('newWidth').value = '';
                document.getElementById('newQty').value = '1';
            }
        }

        function removePanel(index) {
            panels.splice(index, 1);
            renderPanels();
        }

        function renderPanels() {
            const container = document.getElementById('panelList');
            container.innerHTML = '';

            panels.forEach((panel, index) => {
                const div = document.createElement('div');
                div.className = 'panel-item';
                div.innerHTML = `
                    <input type="number" value="${panel.length}" onchange="updatePanel(${index}, 'length', this.value)" step="0.01">
                    <input type="number" value="${panel.width}" onchange="updatePanel(${index}, 'width', this.value)" step="0.01">
                    <input type="number" value="${panel.qty}" onchange="updatePanel(${index}, 'qty', this.value)" min="1" class="qty">
                    <div class="actions">
                        <button class="btn btn-sm btn-success">‚úì</button>
                        <button class="btn btn-sm btn-danger" onclick="removePanel(${index})">‚úï</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updatePanel(index, field, value) {
            if (field === 'qty') {
                panels[index][field] = parseInt(value) || 1;
            } else {
                panels[index][field] = parseFloat(value) || 0;
            }
        }

        function addStockSheet() {
            const length = parseFloat(document.getElementById('stockLength').value);
            const width = parseFloat(document.getElementById('stockWidth').value);
            const qty = parseInt(document.getElementById('stockQty').value) || 1;

            if (length && width) {
                stockSheets = [{ length, width, qty }];
                updateCuttingBoard();
                updateStockDisplay();
                // Clear the cutting board and re-optimize with new dimensions
                document.getElementById('cuttingBoard').innerHTML = '';
                optimizeCutting();
            }
        }

        function updateStockDisplay() {
            const sheet = stockSheets[0];
            document.getElementById('currentStockDisplay').textContent = `${sheet.length} √ó ${sheet.width}`;
        }

        function updateCuttingBoard() {
            const board = document.getElementById('cuttingBoard');
            const sheet = stockSheets[0];
            
            // Calculate scale to fit within available space while maintaining proportions
            const maxWidth = 700;  // Maximum width for the cutting board
            const maxHeight = 500; // Maximum height for the cutting board
            
            const scaleX = maxWidth / sheet.length;
            const scaleY = maxHeight / sheet.width;
            const scale = Math.min(scaleX, scaleY); // Use the smaller scale to fit both dimensions
            
            // Set dimensions maintaining exact proportions
            board.style.width = (sheet.length * scale) + 'px';
            board.style.height = (sheet.width * scale) + 'px';
        }

        function toggleOption(element) {
            element.classList.toggle('active');
        }

        // Bin packing algorithm (Bottom-Left Fit)
        function optimizeCutting() {
            const board = document.getElementById('cuttingBoard');
            const sheet = stockSheets[0];
            
            // Calculate scale to fit within available space while maintaining proportions
            const maxWidth = 700;
            const maxHeight = 500;
            const scaleX = maxWidth / sheet.length;
            const scaleY = maxHeight / sheet.width;
            const scale = Math.min(scaleX, scaleY);
            
            const kerf = parseFloat(document.getElementById('kerfThickness').value) || 0.25;

            // Clear existing pieces
            board.innerHTML = '';
            placedPieces = [];

            // Create all required pieces
            const allPieces = [];
            panels.forEach((panel, panelIndex) => {
                for (let i = 0; i < panel.qty; i++) {
                    allPieces.push({
                        length: panel.length,
                        width: panel.width,
                        panelIndex,
                        id: `piece_${panelIndex}_${i}`
                    });
                }
            });

            // Sort pieces by area (largest first)
            allPieces.sort((a, b) => (b.length * b.width) - (a.length * a.width));

            // Place pieces using bottom-left fit
            const placedRects = [];
            allPieces.forEach(piece => {
                const position = findBestPosition(piece, placedRects, sheet, kerf);
                if (position) {
                    const rect = {
                        x: position.x,
                        y: position.y,
                        length: piece.length,
                        width: piece.width,
                        piece
                    };
                    placedRects.push(rect);
                    createPieceElement(rect, scale, board);
                }
            });

            updateStats(placedRects, sheet);
        }

        function findBestPosition(piece, placedRects, sheet, kerf) {
            // Try to place piece at various positions
            const positions = [];
            
            // Add corner position
            positions.push({ x: 0, y: 0 });
            
            // Add positions based on existing rectangles
            placedRects.forEach(rect => {
                positions.push({ x: rect.x + rect.length + kerf, y: rect.y });
                positions.push({ x: rect.x, y: rect.y + rect.width + kerf });
                positions.push({ x: rect.x + rect.length + kerf, y: rect.y + rect.width + kerf });
            });

            // Sort by bottom-left preference
            positions.sort((a, b) => {
                if (a.y !== b.y) return a.y - b.y;
                return a.x - b.x;
            });

            // Try each position
            for (const pos of positions) {
                if (canPlacePiece(piece, pos.x, pos.y, placedRects, sheet, kerf)) {
                    return pos;
                }
                
                // Try rotated version
                const rotated = { length: piece.width, width: piece.length };
                if (canPlacePiece(rotated, pos.x, pos.y, placedRects, sheet, kerf)) {
                    piece.length = rotated.length;
                    piece.width = rotated.width;
                    return pos;
                }
            }
            
            return null;
        }

        function canPlacePiece(piece, x, y, placedRects, sheet, kerf) {
            // Check if piece fits within sheet bounds
            if (x + piece.length > sheet.length || y + piece.width > sheet.width) {
                return false;
            }

            // Check for overlap with existing pieces
            for (const rect of placedRects) {
                if (!(x >= rect.x + rect.length + kerf || 
                      x + piece.length + kerf <= rect.x ||
                      y >= rect.y + rect.width + kerf || 
                      y + piece.width + kerf <= rect.y)) {
                    return false;
                }
            }
            
            return true;
        }

        function createPieceElement(rect, scale, container) {
            const element = document.createElement('div');
            element.className = 'cut-piece';
            element.id = rect.piece.id;
            element.style.left = (rect.x * scale) + 'px';
            element.style.top = (rect.y * scale) + 'px';
            element.style.width = (rect.length * scale) + 'px';
            element.style.height = (rect.width * scale) + 'px';
            
            element.innerHTML = `
                <div class="dimensions">${rect.length} √ó ${rect.width}</div>
                <div class="label">Panel ${rect.piece.panelIndex + 1}</div>
            `;

            // Add drag functionality
            element.draggable = true;
            element.addEventListener('dragstart', handleDragStart);
            element.addEventListener('dragend', handleDragEnd);

            container.appendChild(element);
        }

        function handleDragStart(e) {
            draggedElement = e.target;
            e.target.classList.add('dragging');
            
            // Calculate offset relative to the element's current position
            const elementRect = e.target.getBoundingClientRect();
            dragOffset.x = e.clientX - elementRect.left;
            dragOffset.y = e.clientY - elementRect.top;
        }

        function handleDragEnd(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
            }
        }

        // Allow dropping on the cutting board
        document.getElementById('cuttingBoard').addEventListener('dragover', e => {
            e.preventDefault();
            if (e.currentTarget === document.getElementById('cuttingBoard')) {
                e.currentTarget.classList.add('dragging-over');
            }
        });

        document.getElementById('cuttingBoard').addEventListener('dragleave', e => {
            if (e.currentTarget === document.getElementById('cuttingBoard')) {
                e.currentTarget.classList.remove('dragging-over');
            }
        });

        document.getElementById('cuttingBoard').addEventListener('drop', e => {
            e.preventDefault();
            const board = document.getElementById('cuttingBoard');
            board.classList.remove('dragging-over');
            
            if (draggedElement) {
                // Get the cutting board's position
                const boardRect = board.getBoundingClientRect();
                
                // Calculate new position relative to the cutting board
                const newX = e.clientX - boardRect.left - dragOffset.x;
                const newY = e.clientY - boardRect.top - dragOffset.y;
                
                // Constrain to cutting board bounds
                const maxX = board.clientWidth - draggedElement.offsetWidth;
                const maxY = board.clientHeight - draggedElement.offsetHeight;
                
                const constrainedX = Math.max(0, Math.min(newX, maxX));
                const constrainedY = Math.max(0, Math.min(newY, maxY));
                
                draggedElement.style.left = constrainedX + 'px';
                draggedElement.style.top = constrainedY + 'px';
            }
        });

        function updateStats(placedRects, sheet) {
            const totalSheetArea = sheet.length * sheet.width;
            const usedArea = placedRects.reduce((sum, rect) => sum + (rect.length * rect.width), 0);
            const wastedArea = totalSheetArea - usedArea;
            const efficiency = (usedArea / totalSheetArea * 100).toFixed(1);

            document.getElementById('usedSheets').textContent = '1';
            document.getElementById('totalUsed').textContent = `${usedArea.toFixed(2)} (${efficiency}%)`;
            document.getElementById('totalWasted').textContent = `${wastedArea.toFixed(2)} (${(100-efficiency)}%)`;
            document.getElementById('totalCuts').textContent = placedRects.length;
        }

        // Handle section collapsing
        document.addEventListener('click', e => {
            if (e.target.classList.contains('section-header')) {
                e.target.parentElement.classList.toggle('collapsed');
            }
        });

        // Handle Enter key for adding panels
        document.addEventListener('keypress', e => {
            if (e.key === 'Enter' && (e.target.id === 'newLength' || e.target.id === 'newWidth' || e.target.id === 'newQty')) {
                addPanel();
            }
        });
    </script>
</body>
</html>